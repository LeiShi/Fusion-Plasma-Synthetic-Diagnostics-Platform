<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>FPSDP.Diagnostics.BES.tools &mdash; BES 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="BES 1.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../FPSDP.html">BES 1.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for FPSDP.Diagnostics.BES.tools</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp2d</span><span class="p">,</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splrep</span>
<span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">fft2</span><span class="p">,</span> <span class="n">ifft2</span>
<span class="kn">import</span> <span class="nn">FPSDP.Diagnostics.Beam.beam</span> <span class="kn">as</span> <span class="nn">beam_</span>
<span class="kn">import</span> <span class="nn">FPSDP.Diagnostics.BES.bes</span> <span class="kn">as</span> <span class="nn">bes_</span>
<span class="kn">import</span> <span class="nn">FPSDP.Plasma.XGC_Profile.load_XGC_local</span> <span class="kn">as</span> <span class="nn">xgc_</span>

<span class="c"># command for using pdflatex for the graph in pgf</span>
<span class="n">pgf_with_rc_fonts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;pgf.texsystem&quot;</span><span class="p">:</span> <span class="s">&quot;pdflatex&quot;</span><span class="p">}</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pgf_with_rc_fonts</span><span class="p">)</span>

<div class="viewcode-block" id="Tools"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools">[docs]</a><span class="k">class</span> <span class="nc">Tools</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Defines a few tools for doing some computations on the BES image</span>
<span class="sd">    </span>
<span class="sd">    Two different methods of initalization have been made:</span>
<span class="sd">    The first one is the usual __init__ function that take as input the photon radiance, the R,Z coordinates</span>
<span class="sd">    and the psin value, and the second one read a npz file with a standard order and calls the __init__ method.</span>

<span class="sd">    :param np.array[Nt,Nfib] I: Photon radiance</span>
<span class="sd">    :param np.array[Nfib] R: R coordinate</span>
<span class="sd">    :param np.array[Nfib] Z: Z coordinate</span>
<span class="sd">    :param np.array[Nfib] psin: :math:`\Psi_n` value</span>
<span class="sd">    :param str name_id: Name defining the data (used for the titles))</span>
<span class="sd">    :param bool I_fluc: Input are fluctuation or total intensity</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">psin</span><span class="p">,</span><span class="n">name_id</span><span class="p">,</span><span class="n">I_fluc</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">I_fluc</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Itot</span> <span class="o">=</span> <span class="n">I</span>
            <span class="n">Iav</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">Iav</span><span class="p">)</span><span class="o">/</span><span class="n">Iav</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">I</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name_id</span> <span class="o">=</span> <span class="n">name_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psin</span> <span class="o">=</span> <span class="n">psin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nfoc</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Tools.init_from_file"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.init_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">name_id</span><span class="p">,</span><span class="n">fluc</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load of file in the numpy format (npz)</span>

<span class="sd">        The data inside it should be in the following order: [I,psin,pos_foc,...]</span>

<span class="sd">        :param str filename: Name of the file</span>
<span class="sd">        :param bool fluc: The intensity inside the file is the total (False) or the fluctuation (True)</span>
<span class="sd">        :return: New instance variable</span>
<span class="sd">        :rtype: Tools</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;arr_0&#39;</span><span class="p">]</span>
        <span class="n">psin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;arr_1&#39;</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;arr_2&#39;</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">psin</span><span class="p">,</span><span class="n">name_id</span><span class="p">,</span><span class="n">fluc</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Tools.interpolate"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">timestep</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Interpolate all the data on a spatial mesh and create this mesh.</span>
<span class="sd">        The interpolation is done for each timestep</span>

<span class="sd">        :param int Nr: Number of points for the discretization in R</span>
<span class="sd">        :param int Nz: Number of points for the discretization in Z </span>
<span class="sd">        :param np.array[Ntime,R,Z] I: Picture to interpolate</span>
<span class="sd">        :param int timestep: Time step wanted (None compute all of them)</span>

<span class="sd">        :return: r,z of the mesh and I on the mesh</span>
<span class="sd">        :rtype: tuple(np.array[Nr],np.array[Nz],np.array[Ntime,Nr,Nz])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span><span class="n">Nr</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span><span class="n">Nz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timestep</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Igrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">kind</span><span class="p">)</span>
                <span class="n">Igrid</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Igrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">I</span><span class="p">[</span><span class="n">timestep</span><span class="p">,:],</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">Igrid</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Igrid</span>
</div>
<div class="viewcode-block" id="Tools.fluctuations_picture"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.fluctuations_picture">[docs]</a>    <span class="k">def</span> <span class="nf">fluctuations_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">timestep</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">total</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot a graph of the fluctuation</span>
<span class="sd">        :param int timestep: Index of the timestep</span>
<span class="sd">        :param int v: Number of ticks for the colorbar</span>
<span class="sd">        :param bool total: Choice between total intensity or only fluctuation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Itot</span><span class="p">[</span><span class="n">timestep</span><span class="p">,:]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Itot</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Itot</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">timestep</span><span class="p">,:]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">psin</span><span class="p">,[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R[m]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Z[m]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Tools.fluctuations_movie"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.fluctuations_movie">[docs]</a>    <span class="k">def</span> <span class="nf">fluctuations_movie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">name_movie</span><span class="o">=</span><span class="s">&#39;movie_fl.mp4&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make a movie from the data and save it in movie_fl.mp4</span>
<span class="sd">        :param int v: Number of ticks for the colorbar</span>
<span class="sd">        :param str name_movie: Name of the movie that will be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R[m]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Z[m]&#39;</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">),</span><span class="n">v</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;Timestep: &#39;</span><span class="p">,</span> <span class="n">i</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Timestep : {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">v</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">psin</span><span class="p">,[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># call the animator.  blit=True means only re-draw the parts that have changed.</span>
        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">repeat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="c"># save the animation as an mp4.  This requires ffmpeg or mencoder to be</span>
        <span class="c"># installed.  The extra_args ensure that the x264 codec is used, so that</span>
        <span class="c"># the video can be embedded in html5.  You may need to adjust this for</span>
        <span class="c"># your system: for more information, see</span>
        <span class="c"># http://matplotlib.sourceforge.net/api/animation_api.html</span>

        <span class="n">FFwriter</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FFMpegWriter</span><span class="p">()</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name_movie</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">FFwriter</span><span class="p">,</span><span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s">&#39;libx264&#39;</span><span class="p">])</span>

        </div>
<div class="viewcode-block" id="Tools.comparison_picture"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.comparison_picture">[docs]</a>    <span class="k">def</span> <span class="nf">comparison_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tool2</span><span class="p">,</span><span class="n">timestep</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">total</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make a picture from the data.</span>

<span class="sd">        :param Tools tool2: Second instance of the Tools class</span>
<span class="sd">        :param int timestep: Index of the timestep</span>
<span class="sd">        :param int v: Number of ticks for the colorbar</span>
<span class="sd">        :param bool total: Total intensity or only fluctuation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Itot</span>
            <span class="n">I2</span> <span class="o">=</span> <span class="n">tool2</span><span class="o">.</span><span class="n">Itot</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">v</span><span class="p">)</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I2</span><span class="p">),</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span>
            <span class="n">I2</span> <span class="o">=</span> <span class="n">tool2</span><span class="o">.</span><span class="n">I</span>
            <span class="n">lim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">I</span><span class="p">)])</span>
            <span class="n">lim2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I2</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">I2</span><span class="p">)])</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">v</span><span class="p">)</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I2</span><span class="p">),</span><span class="n">v</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;R[m]&#39;</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Z[m]&#39;</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;R[m]&#39;</span><span class="p">)</span>

        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">name_id</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_id</span><span class="p">)</span>
        
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&#39;Timestep : {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestep</span><span class="p">))</span>
        
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">tri0</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">I2</span><span class="p">[</span><span class="n">timestep</span><span class="p">,:],</span><span class="n">v2</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">psin</span><span class="p">,[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">tri1</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">I</span><span class="p">[</span><span class="n">timestep</span><span class="p">,:],</span><span class="n">v1</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">psin</span><span class="p">,[</span><span class="mi">1</span><span class="p">])</span>
        

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tri0</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tri1</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="Tools.comparison_movie"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.comparison_movie">[docs]</a>    <span class="k">def</span> <span class="nf">comparison_movie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tool2</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">name_movie</span><span class="o">=</span><span class="s">&#39;movie_comp.mp4&#39;</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make a movie from the data and save it in movie_comp.mp4</span>
<span class="sd">        self should be the density fluctuation</span>
<span class="sd">        :param Tools tool2: BES images</span>
<span class="sd">        :param int v: Number of ticks for the colorbar</span>
<span class="sd">        :param str name_movie: Name of the output movie</span>
<span class="sd">        :param bool interpolation: Choice of making an interpolation on a grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Nr</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">Nz</span> <span class="o">=</span> <span class="mi">120</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
        <span class="k">if</span> <span class="n">interpolation</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">I_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

        <span class="n">lim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">)])</span>
        <span class="n">lim2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">I</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">I</span><span class="p">)])</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lim1</span><span class="p">,</span><span class="n">lim1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lim2</span><span class="p">,</span><span class="n">lim2</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        
        <span class="c">#v1 = np.linspace(np.min(self.I),np.max(self.I),v)</span>
        <span class="c">#v2 = np.linspace(np.min(tool2.I),np.max(tool2.I),v)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;R[m]&#39;</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Z[m]&#39;</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;R[m]&#39;</span><span class="p">)</span>

        
        <span class="n">tri0</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">v1</span><span class="p">)</span>
        <span class="n">tri1</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">v2</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tri0</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tri1</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


        <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;Timestep: &#39;</span><span class="p">,</span> <span class="n">i</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">name_id</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_id</span><span class="p">)</span>
  
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&#39;Timestep : {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interpolation</span><span class="p">:</span>
                <span class="n">tri0</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tri0</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">v2</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">tool2</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">tool2</span><span class="o">.</span><span class="n">psin</span><span class="p">,[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interpolation</span><span class="p">:</span>
                <span class="n">tri1</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">I_id</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tri1</span> <span class="o">=</span> <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">v1</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">psin</span><span class="p">,[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># call the animator.  blit=True means only re-draw the parts that have changed.</span>
        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">repeat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="c"># save the animation as an mp4.  This requires ffmpeg or mencoder to be</span>
        <span class="c"># installed.  The extra_args ensure that the x264 codec is used, so that</span>
        <span class="c"># the video can be embedded in html5.  You may need to adjust this for</span>
        <span class="c"># your system: for more information, see</span>
        <span class="c"># http://matplotlib.sourceforge.net/api/animation_api.html</span>

        <span class="n">FFwriter</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FFMpegWriter</span><span class="p">()</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name_movie</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">FFwriter</span><span class="p">,</span><span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s">&#39;libx264&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="Tools.crosscorrelation"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.crosscorrelation">[docs]</a>    <span class="k">def</span> <span class="nf">crosscorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nr</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">dr_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dz_max</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">dkr_max</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">dkz_max</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="s">&#39;3d&#39;</span><span class="p">,</span><span class="n">figure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot or just compute the shape of the crosscorrelation from the point R[0],Z[0]</span>

<span class="sd">        :param int Nr: Number of points for the discretization</span>
<span class="sd">        :param int Nz: Number of points for the discretization</span>
<span class="sd">        :param float dr_max: Distance max to show in the figure for the real space crosscorrelation</span>
<span class="sd">        :param float dz_max: Distance max to show in the figure for the real space crosscorrelation</span>
<span class="sd">        :param float dkr_max: Distance max to show in the figure for the Fourier space crosscorrelation</span>
<span class="sd">        :param float dkz_max: Distance max to show in the figure for the Fourier space crosscorrelation</span>
<span class="sd">        :param str graph: Choice between surface or contourf graph (&#39;2d&#39;)</span>
<span class="sd">        :param bool figure: Choice between plot or computing</span>

<span class="sd">        :return: If (figure == False), the correlation and its fourier transform are returned.\</span>
<span class="sd">        The size of the two arrays is defined by the cutoff limits (dr_max,dkr_max,...))</span>
<span class="sd">        :rtype: (np.array[R,Z],np.array[R,Z])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">correlate2d</span>
        <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>

        <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Igrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Igrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">corr</span> <span class="o">+=</span> <span class="n">correlate2d</span><span class="p">(</span><span class="n">Igrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">Igrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;miss&#39;</span>


        <span class="n">corr</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Nr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">temp</span><span class="p">[:</span><span class="n">Nr</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">Nr</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">temp</span><span class="p">[</span><span class="n">Nr</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[:</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">temp</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">z</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="n">indr_</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">dr_max</span><span class="p">)</span>
        <span class="n">indz_</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span><span class="o">&lt;</span><span class="n">dz_max</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">indr_</span><span class="p">,</span><span class="n">indz_</span><span class="p">)</span>
        
        <span class="n">rm</span><span class="p">,</span> <span class="n">zm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">indr_</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">indz_</span><span class="p">])</span>
        <span class="n">fft_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">corr</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Nr</span><span class="o">*</span><span class="n">Nz</span><span class="p">)</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">corr</span><span class="p">,[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indr_</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indz_</span><span class="p">)])</span>
        
        <span class="n">krfft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">kzfft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Nz</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">indrfft</span> <span class="o">=</span> <span class="p">(</span><span class="n">krfft</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">krfft</span> <span class="o">&lt;</span> <span class="n">dkr_max</span><span class="p">)</span>
        <span class="n">indzfft</span> <span class="o">=</span> <span class="p">(</span><span class="n">kzfft</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">kzfft</span> <span class="o">&lt;</span> <span class="n">dkz_max</span><span class="p">)</span>
        <span class="n">krfft</span><span class="p">,</span><span class="n">kzfft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">krfft</span><span class="p">[</span><span class="n">indrfft</span><span class="p">],</span><span class="n">kzfft</span><span class="p">[</span><span class="n">indzfft</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">figure</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Correlation&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">graph</span> <span class="o">==</span> <span class="s">&#39;3d&#39;</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s">&#39;3d&#39;</span><span class="p">)</span>
                <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span><span class="n">zm</span><span class="p">,</span><span class="n">corr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">surf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">indr_</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">indz_</span><span class="p">],</span><span class="n">corr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">)</span>

            <span class="n">fft_</span> <span class="o">=</span> <span class="n">fft_corr</span><span class="p">[</span><span class="n">indrfft</span><span class="p">,:]</span>
            <span class="n">fft_</span> <span class="o">=</span> <span class="n">fft_</span><span class="p">[:,</span><span class="n">indzfft</span><span class="p">]</span>
            
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;FFT of the Correlation&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">graph</span> <span class="o">==</span> <span class="s">&#39;3d&#39;</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s">&#39;3d&#39;</span><span class="p">)</span>
                <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">krfft</span><span class="p">,</span><span class="n">kzfft</span><span class="p">,</span><span class="n">fft_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span><span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">surf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">krfft</span><span class="p">,</span><span class="n">kzfft</span><span class="p">,</span><span class="n">fft_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;k_r&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;k_z&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">indr_</span><span class="p">],</span><span class="n">corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">indz_</span><span class="p">],</span><span class="n">corr</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Z&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">corr</span><span class="p">,</span><span class="n">fft_</span>
</div>
<div class="viewcode-block" id="Tools.radial_dep_correlation"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.radial_dep_correlation">[docs]</a>    <span class="k">def</span> <span class="nf">radial_dep_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Nr</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Zref</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">figure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Show the characteristic length of the radial correlation length as a function</span>
<span class="sd">        of the radial position</span>

<span class="sd">        :param int Nr: Number of points for the discretization</span>
<span class="sd">        :param fload Zref: Horizontal plane wanted</span>
<span class="sd">        :param float eps: Relative interval accepted for Zref</span>
<span class="sd">        :param bool figure: Choice between plot or computing</span>

<span class="sd">        :return: If (figure == False), the radius and the correlation are returned.\</span>
<span class="sd">        :rtype: (np.array[Nr],np.array[Nr])</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="n">Zref</span><span class="p">)</span><span class="o">/</span><span class="n">Zref</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        
        <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nr</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span><span class="n">Nr</span><span class="p">)</span>

        <span class="n">R_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">Igrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">,</span><span class="n">Nr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">R_temp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">Igrid</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">temp</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">Igrid</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">Igrid</span><span class="p">[:,</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">r</span><span class="p">[(</span><span class="n">temp</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">figure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="p">,</span><span class="n">corr</span><span class="p">,</span><span class="n">ind</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">corr</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R [m]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Correlation length&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Tools.comparison_radial_correlation_lenght"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.Tools.comparison_radial_correlation_lenght">[docs]</a>    <span class="k">def</span> <span class="nf">comparison_radial_correlation_lenght</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tool2</span><span class="p">,</span><span class="n">Nr</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">Zref</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Show the characteristic length of the radial correlation length as a function</span>
<span class="sd">        of the radial position for two different diagnostics.</span>

<span class="sd">        :param Tools tool2: Second instance of the Tools class</span>
<span class="sd">        :param int Nr: Number of points for the discretization</span>
<span class="sd">        :param fload Zref: Horizontal plane wanted</span>
<span class="sd">        :param float eps: Relative interval accepted for Zref</span>
<span class="sd">        :param bool figure: Choice between plot or computing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r0</span><span class="p">,</span> <span class="n">corr0</span><span class="p">,</span><span class="n">ind0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radial_dep_correlation</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Zref</span><span class="p">,</span><span class="n">eps</span><span class="p">,</span><span class="n">figure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;First computation done&#39;</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">corr1</span><span class="p">,</span><span class="n">ind1</span> <span class="o">=</span> <span class="n">tool2</span><span class="o">.</span><span class="n">radial_dep_correlation</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Zref</span><span class="p">,</span><span class="n">eps</span><span class="p">,</span><span class="n">figure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">corr0</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name_id</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">corr1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">tool2</span><span class="o">.</span><span class="n">name_id</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Radius [m]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Correlation length [cm]&#39;</span><span class="p">)</span>

        <span class="n">psi_n</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">ind0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">psin</span><span class="p">[</span><span class="n">ind0</span><span class="p">])</span>
        <span class="n">psi_n</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">psi_n</span><span class="p">)</span>

        <span class="n">ind_sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">psi_n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind_sep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ind_sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ind_sep</span><span class="p">)</span>
        <span class="n">xa</span><span class="p">,</span><span class="n">xb</span><span class="p">,</span><span class="n">ya</span><span class="p">,</span><span class="n">yb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r0</span><span class="p">[</span><span class="n">ind_sep</span><span class="p">],</span><span class="n">r0</span><span class="p">[</span><span class="n">ind_sep</span><span class="p">]],[</span><span class="n">ya</span><span class="p">,</span><span class="n">yb</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


</div></div>
<div class="viewcode-block" id="put_two_files_together"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.put_two_files_together">[docs]</a><span class="k">def</span> <span class="nf">put_two_files_together</span><span class="p">(</span><span class="n">name1</span><span class="p">,</span><span class="n">name2</span><span class="p">,</span><span class="n">outputname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; When doing two simulations on a different time intervals,</span>
<span class="sd">    this function can be used to put the output in one file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name1</span><span class="p">)</span>
    <span class="n">I1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="s">&#39;arr_0&#39;</span><span class="p">]</span>
    <span class="n">psin1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="s">&#39;arr_1&#39;</span><span class="p">]</span>
    <span class="n">pos1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="s">&#39;arr_2&#39;</span><span class="p">]</span>

    <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="s">&#39;arr_0&#39;</span><span class="p">]</span>
    <span class="n">psin2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="s">&#39;arr_1&#39;</span><span class="p">]</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="s">&#39;arr_2&#39;</span><span class="p">]</span>

    <span class="n">check</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos1</span> <span class="o">!=</span> <span class="n">pos2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psin1</span> <span class="o">!=</span> <span class="n">psin2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Not the same simulation&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">I1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">I2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">I1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">I</span><span class="p">[:</span><span class="n">I1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="n">I1</span>
        <span class="n">I</span><span class="p">[</span><span class="n">I1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,:]</span> <span class="o">=</span> <span class="n">I2</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">outputname</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">psin1</span><span class="p">,</span><span class="n">pos1</span><span class="p">,</span><span class="n">data1</span><span class="p">[</span><span class="s">&#39;arr_3&#39;</span><span class="p">])</span>
        
    </div>
<span class="sd">&quot;&quot;&quot; Define a few test for checking the data given by the code</span>
<span class="sd">It contains all the code used for the figure in my report</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">&#39;FPSDP/Diagnostics/BES/bes.in&#39;</span>



<div class="viewcode-block" id="beam_density"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.beam_density">[docs]</a><span class="k">def</span> <span class="nf">beam_density</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compare the beam density of the equilibrium case and of the equilibrium+fluctuations case</span>

<span class="sd">    Three plots will be done: a first one with the relative difference between the equilibrium and the fluctuation cases,</span>
<span class="sd">    a second one with the absolute value of both and the last one shows the ratio of each components as a function of the distance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">eq</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>
    <span class="n">nb_eq</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">density_beam</span>
    <span class="n">ne_eq</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_quantities</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="s">&#39;ne&#39;</span><span class="p">],</span><span class="bp">True</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">eq</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>
    <span class="n">nb_fl</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">density_beam</span>
    <span class="n">ne_fl</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_quantities</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="s">&#39;ne&#39;</span><span class="p">],</span><span class="bp">False</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="o">-</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,((</span><span class="n">nb_eq</span><span class="o">-</span><span class="n">nb_fl</span><span class="p">)</span><span class="o">/</span><span class="n">nb_eq</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance [m]&#39;</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;1st component&#39;</span><span class="p">,</span><span class="s">&#39;2nd component&#39;</span><span class="p">,</span><span class="s">&#39;3rd component&#39;</span><span class="p">],</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">nb_eq</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">nb_fl</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Beam density [m$^{-3}$]&#39;</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;1st Eq&#39;</span><span class="p">,</span><span class="s">&#39;2nd Eq&#39;</span><span class="p">,</span><span class="s">&#39;3rd Eq&#39;</span><span class="p">],</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,((</span><span class="n">ne_eq</span><span class="o">-</span><span class="n">ne_fl</span><span class="p">)</span><span class="o">/</span><span class="n">ne_eq</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance [m]&#39;</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">ne_eq</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">ne_fl</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;Equilibrium&#39;</span><span class="p">,</span><span class="s">&#39;Fluctuations&#39;</span><span class="p">],</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Electron Density [m$^{-3}$]&#39;</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nb_eq</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,(</span><span class="n">nb_eq</span><span class="o">/</span><span class="n">tot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nb_fl</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dl</span><span class="p">,(</span><span class="n">nb_fl</span><span class="o">/</span><span class="n">tot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;1st Eq&#39;</span><span class="p">,</span><span class="s">&#39;2nd Eq&#39;</span><span class="p">,</span><span class="s">&#39;3rd Eq&#39;</span><span class="p">],</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance [m]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Ratio&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="beam_emission"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.beam_emission">[docs]</a><span class="k">def</span> <span class="nf">beam_emission</span><span class="p">(</span><span class="n">Nr</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">81</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Shows the effect of the beam density on the emission and the effect of the lifetime.</span>

<span class="sd">    Three plots will be done: a first one with the emission without the lifetime, a second one with</span>
<span class="sd">    lifetime and a last one that show the relative difference between the two</span>

<span class="sd">    :param int Nr: Number of points along the radial direction of the beam</span>
<span class="sd">    :param int t: Timestep wanted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>

    <span class="n">r_max</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="o">-</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">r_max</span><span class="p">,</span><span class="n">r_max</span><span class="p">,</span><span class="n">Nr</span><span class="p">)</span>
    <span class="n">R</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">dl</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">)</span>
    <span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">L</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">perp</span>
    <span class="n">emis</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_emis</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">emis_l</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_emis_lifetime</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>

    <span class="n">emis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">emis</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Nr</span><span class="p">))</span>
    <span class="n">emis_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">emis_l</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Nr</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Nr</span><span class="p">))</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Nr</span><span class="p">))</span>

    <span class="n">v</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Photon radiance&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">emis</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">stddev_h</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="n">width</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance from the central line [m]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Distance from the source [m]&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Photon radiance&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">emis_l</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="n">width</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance from the central line [m]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Distance from the source [m]&#39;</span><span class="p">)</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Relative Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="p">,(</span><span class="n">emis_l</span><span class="o">-</span><span class="n">emis</span><span class="p">)</span><span class="o">/</span><span class="n">emis</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="n">width</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">dl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;--k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance from the central line [m]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Distance from the source [m]&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="check_convergence_beam_density"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_beam_density">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_beam_density</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span><span class="n">eq</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the error of the beam density at the last computed point as a function of</span>
<span class="sd">    the number of intervals.</span>

<span class="sd">    :param int t: Time step wanted</span>
<span class="sd">    :param bool eq: If equilibrium is wanted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dphi</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">Nsample</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">beam_comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Nsample</span><span class="p">))</span>
    <span class="n">Nref</span> <span class="o">=</span> <span class="mi">3000</span>

    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">eq</span> <span class="o">=</span> <span class="n">eq</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nsample</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">Nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">()</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>
        <span class="n">nb</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">density_beam</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">Nz</span> <span class="o">=</span> <span class="n">Nref</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">()</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>
    <span class="n">nbref</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">density_beam</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c">#np.save(&#39;test_beam_conv&#39;,np.abs(nb-nbref[:,np.newaxis])/nbref[:,np.newaxis])</span>
    <span class="n">nb_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;test_beam_conv.npy&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">nb</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">nbref</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">nbref</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Beam Component {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">nb_test</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Test Function&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Beam Density&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Number of intervals&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_convergence_lifetime"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_lifetime">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_lifetime</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">81</span><span class="p">,</span><span class="n">fib</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">beam_comp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the error as a function of the number of interval for the computation</span>
<span class="sd">    of the emission with lifetime.</span>

<span class="sd">    :param int t: Timestep wanted</span>
<span class="sd">    :param int fib: Index of the fiber to use for the computation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dphi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_max</span> <span class="o">=</span> <span class="mf">8.0</span>

    <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">30</span><span class="p">))</span>
    <span class="n">Nref</span> <span class="o">=</span> <span class="mi">40000</span>

    <span class="c">#bes.pos_foc[fib,:] += 0.4*bes.beam.direc</span>
    <span class="n">emis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c">#test = np.zeros(N.shape)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">Nlt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">i</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">Nlt</span> <span class="o">=</span> <span class="n">Nlt</span>
        <span class="n">emis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_emis_lifetime</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">,:],</span><span class="n">t</span><span class="p">)[</span><span class="n">beam_comp</span><span class="p">,:]</span>
        <span class="c">#test[i] = bes.beam.get_emis_lifetime(bes.pos_foc[fib,:],t,test=True)[beam_comp,:]</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">Nlt</span> <span class="o">=</span> <span class="n">Nref</span>
    <span class="n">emis_ref</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">get_emis_lifetime</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">,:],</span><span class="n">t</span><span class="p">)[</span><span class="n">beam_comp</span><span class="p">,:]</span>
    <span class="c">#test_ref = bes.beam.get_emis_lifetime(bes.pos_foc[fib,:],t,test=True)[beam_comp,:]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Lifetime convergence&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">emis</span><span class="o">-</span><span class="n">emis_ref</span><span class="p">)</span><span class="o">/</span><span class="n">emis_ref</span><span class="p">))</span>
    <span class="c">#plt.loglog(N,np.abs((test-test_ref)/test_ref))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Number of interval&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_convergence_field_line"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_field_line">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_field_line</span><span class="p">(</span><span class="n">fib</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">phi</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">nber_plane</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">fwd</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the error of the field line following integration as a function of the integration step</span>
<span class="sd">    at the position given by the focus point of the fiber and by phi</span>

<span class="sd">    :param int fib: Index of the fiber</span>
<span class="sd">    :param float phi: Angle to use for the position</span>
<span class="sd">    :param int nber_plane: Number of planes in XGC1</span>
<span class="sd">    :param bool fwd: Choice of the forward or backward direction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">foc</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">,:]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">foc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">foc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">Nref</span> <span class="o">=</span><span class="mi">5000</span>

    <span class="n">dphi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">nber_plane</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
    <span class="n">dphi_ref</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">nber_plane</span><span class="o">*</span><span class="n">Nref</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fwd</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">pos_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="n">prev</span><span class="p">,</span><span class="n">nex</span> <span class="o">=</span> <span class="n">xgc_</span><span class="o">.</span><span class="n">get_interp_planes_local</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dphi_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dphi</span><span class="p">):</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dphi</span> <span class="o">=</span> <span class="n">dphi_</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find_interp_positions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">prev</span><span class="p">,</span><span class="n">nex</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c"># R</span>
        <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Z</span>
        <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="c"># s</span>
        
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dphi</span> <span class="o">=</span> <span class="n">dphi_ref</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find_interp_positions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">prev</span><span class="p">,</span><span class="n">nex</span><span class="p">)</span>
    <span class="n">pos_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c"># R</span>
    <span class="n">pos_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Z</span>
    <span class="n">pos_ref</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="c"># s</span>

    <span class="k">print</span> <span class="n">temp</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">dphi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">dphi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Z&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">dphi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">pos_ref</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;$\Delta\phi [rad]$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_convergence_interpolation_data"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_interpolation_data">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_interpolation_data</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span><span class="n">fib</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">phi</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">nber_plane</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">eq</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the error of the field line following interpolation as a function of the</span>
<span class="sd">    step size of the field line integration at the position given by </span>
<span class="sd">    the focus point of the fiber and by phi</span>
<span class="sd">    </span>
<span class="sd">    :param int t: Timestep wanted</span>
<span class="sd">    :param int fib: Index of the fiber</span>
<span class="sd">    :param float phi: Angle to use for the position</span>
<span class="sd">    :param int nber_plane: Number of planes in XGC1</span>
<span class="sd">    :param bool eq: Choice of the equilibrium or not</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">foc</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">,:]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">foc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">foc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">Nref</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="n">dphi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">nber_plane</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
    <span class="n">dphi_ref</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">nber_plane</span><span class="o">*</span><span class="n">Nref</span><span class="p">)</span>

        
    <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dphi_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dphi</span><span class="p">):</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dphi</span> <span class="o">=</span> <span class="n">dphi_</span>
        <span class="n">ne</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">interpolate_data</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="s">&#39;ne&#39;</span><span class="p">],</span><span class="n">eq</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dphi</span> <span class="o">=</span> <span class="n">dphi_ref</span>
    <span class="n">ne_ref</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">interpolate_data</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="s">&#39;ne&#39;</span><span class="p">],</span><span class="n">eq</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Interpolation of data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">ne</span><span class="o">-</span><span class="n">ne_ref</span><span class="p">)</span><span class="o">/</span><span class="n">ne_ref</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>    
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Number of interval&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_convergence_optic_int"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_optic_int">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_optic_int</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">81</span><span class="p">,</span><span class="n">fib</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the error of the image captured by a fiber as a function of the number</span>
<span class="sd">    of interval for the integration along the optical axis</span>

<span class="sd">    :param int t: Time step wanted</span>
<span class="sd">    :param int fib: Index of the fiber</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">compute_beam_on_mesh</span><span class="p">()</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">,:])</span>
    
    <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">N_ref</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">Nsample</span><span class="p">)</span>
    <span class="n">I1D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nsample</span><span class="p">)</span>
    <span class="n">I2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nsample</span><span class="p">)</span>
    <span class="c">#Itest = np.zeros(Nsample)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">N_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">i</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">Nint</span> <span class="o">=</span> <span class="n">N_</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">type_int</span> <span class="o">=</span> <span class="s">&#39;1D&#39;</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">solid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">bes</span><span class="o">.</span><span class="n">Nint</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">21</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">I1D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">intensity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comp_eps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">bes</span><span class="o">.</span><span class="n">type_int</span> <span class="o">=</span> <span class="s">&#39;2D&#39;</span>
        <span class="n">I2D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">intensity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comp_eps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c">#Itest[i] = bes.intensity(t,0,comp_eps=True,test=True)</span>
        

    <span class="n">bes</span><span class="o">.</span><span class="n">Nint</span> <span class="o">=</span> <span class="n">N_ref</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">type_int</span> <span class="o">=</span> <span class="s">&#39;1D&#39;</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">solid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">bes</span><span class="o">.</span><span class="n">Nint</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">21</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">I1D_ref</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">intensity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comp_eps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">type_int</span> <span class="o">=</span> <span class="s">&#39;2D&#39;</span>
    <span class="n">I2D_ref</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">intensity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comp_eps</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#Itest_ref = bes.intensity(t,0,comp_eps=True,test=True)</span>
    

    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Optical integral&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">I1D</span><span class="o">-</span><span class="n">I1D_ref</span><span class="p">)</span><span class="o">/</span><span class="n">I1D_ref</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;1D integral&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">I2D</span><span class="o">-</span><span class="n">I2D_ref</span><span class="p">)</span><span class="o">/</span><span class="n">I2D_ref</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;2D integral&#39;</span><span class="p">)</span>
    <span class="c">#plt.loglog(N,np.abs((Itest-Itest_ref)/Itest_ref),label=&#39;Test&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Number of interval&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="check_convergence_solid_angle_to_analy"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_solid_angle_to_analy">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_solid_angle_to_analy</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">Nth</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">Nr</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Is used for checking the convergence to the analytical formula</span>
<span class="sd">    in the case where the intersection tends to a single point</span>

<span class="sd">    :param float R: Distance from the central axis of the emission position</span>
<span class="sd">    :param float Z: Z-coordinate (along the central line)</span>
<span class="sd">    :param float radius: Radius of the obstacle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">FPSDP.Maths.Funcs</span> <span class="kn">import</span> <span class="n">solid_angle_disk</span><span class="p">,</span> <span class="n">solid_angle_seg</span>
    <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span><span class="n">Nsample</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nsample</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">]]))</span>
    
    <span class="n">solid</span> <span class="o">=</span> <span class="n">solid_angle_seg</span><span class="p">(</span><span class="n">pos</span><span class="p">,[</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">],</span><span class="n">radius</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Nth</span><span class="p">,</span><span class="n">Nr</span><span class="p">)</span>
    <span class="n">analytical</span> <span class="o">=</span> <span class="n">solid_angle_disk</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">radius</span><span class="p">)</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Verification of the Solid Angle Computation&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">solid</span><span class="o">-</span><span class="n">analytical</span><span class="p">)</span><span class="o">/</span><span class="n">analytical</span><span class="p">),</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Cosine of the Intersection Angle&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="check_convergence_solid_angle"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_convergence_solid_angle">[docs]</a><span class="k">def</span> <span class="nf">check_convergence_solid_angle</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Plot the error of the solid angle as a function of the number of interval for R and :math:`\Theta`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">FPSDP.Maths.Funcs</span> <span class="kn">as</span> <span class="nn">F</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.012</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.1268857</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.047708</span><span class="p">,</span><span class="mf">0.1422107</span><span class="p">]])]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.15</span>

    <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">Nsample</span><span class="p">)</span>

    <span class="n">N_ref</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nsample</span><span class="p">)</span>
    <span class="n">Th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nsample</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">N_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">i</span>
        <span class="n">N_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N_</span><span class="p">)</span>
        <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">solid_angle_seg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">N_ref</span><span class="p">,</span><span class="n">N_</span><span class="p">)</span>
        <span class="n">Th</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">solid_angle_seg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">N_</span><span class="p">,</span><span class="n">N_ref</span><span class="p">)</span>

    <span class="n">ref</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">solid_angle_seg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">N_ref</span><span class="p">,</span><span class="n">N_ref</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Solid Angle&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">R</span><span class="o">-</span><span class="n">ref</span><span class="p">)</span><span class="o">/</span><span class="n">ref</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">Th</span><span class="o">-</span><span class="n">ref</span><span class="p">)</span><span class="o">/</span><span class="n">ref</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;$\Theta$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Number of interval&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="check_field_line_integration"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_field_line_integration">[docs]</a><span class="k">def</span> <span class="nf">check_field_line_integration</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="mf">2.23</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">phi</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Nrot</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">fwd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">data_name</span><span class="o">=</span><span class="s">&#39;/project/projectdirs/m499/jlang/particle_pinch/&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Use the coordinate of a fiber for making a field line integration</span>
<span class="sd">    on Nrot tour and plot the value of :math:`\psi_n` at each toroidal planes.</span>

<span class="sd">    :param float R: Initial position</span>
<span class="sd">    :param float Z: Initial position</span>
<span class="sd">    :param int Nrot: Number of toroidal tour</span>
<span class="sd">    :param bool fwd: Choice between forward or backward rotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Rinit</span> <span class="o">=</span> <span class="n">R</span>
    <span class="n">Zinit</span> <span class="o">=</span> <span class="n">Z</span>
    <span class="c"># the value of the limits are random, we do not care about them in this function</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xgc_</span><span class="o">.</span><span class="n">XGC_Loader_local</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">182</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="c"># take all the planes into account</span>
    <span class="n">n_plane</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">n_plane</span>
    
    <span class="n">Rcur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="n">Zcur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">phicur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_plane</span><span class="o">*</span><span class="n">Nrot</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_plane</span><span class="o">*</span><span class="n">Nrot</span><span class="p">)</span>

    <span class="n">dPhi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">n_plane</span>
    <span class="n">phi_planes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_plane</span><span class="p">)</span><span class="o">*</span><span class="n">dPhi</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">shift</span>

    <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">CO_DIR</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plane</span><span class="o">*</span><span class="n">Nrot</span><span class="p">):</span>
        <span class="n">prevplane</span><span class="p">,</span><span class="n">nextplane</span> <span class="o">=</span> <span class="n">xgc_</span><span class="o">.</span><span class="n">get_interp_planes_local</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">phicur</span><span class="p">)</span>
        <span class="c"># MAYBE NEED TO CHANGE IT IF data.CO_DIR (I do not have data with it for checking)</span>
        <span class="c"># this condition is due to the fact that phicur == phi_planes and that I want to</span>
        <span class="c"># go to a next plane</span>
        <span class="k">if</span> <span class="n">phicur</span> <span class="o">==</span> <span class="n">phi_planes</span><span class="p">[</span><span class="n">nextplane</span><span class="p">]:</span>
            <span class="n">nextplane</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">nextplane</span> <span class="o">=</span> <span class="n">nextplane</span> <span class="o">%</span> <span class="n">n_plane</span>

        <span class="n">interp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find_interp_positions</span><span class="p">(</span><span class="n">Rcur</span><span class="p">,</span><span class="n">Zcur</span><span class="p">,</span><span class="n">phicur</span><span class="p">,</span><span class="n">prevplane</span><span class="p">,</span><span class="n">nextplane</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fwd</span><span class="p">:</span>
            <span class="n">Rcur</span> <span class="o">=</span> <span class="n">interp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">Zcur</span> <span class="o">=</span> <span class="n">interp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">phicur</span> <span class="o">=</span> <span class="n">phi_planes</span><span class="p">[</span><span class="n">nextplane</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Rcur</span> <span class="o">=</span> <span class="n">interp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">Zcur</span> <span class="o">=</span> <span class="n">interp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">phicur</span> <span class="o">=</span> <span class="n">phi_planes</span><span class="p">[</span><span class="n">prevplane</span><span class="p">]</span>

        <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rcur</span>
        <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Zcur</span>

    <span class="n">psi</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">psi_interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">psi_x</span>
    <span class="n">psi_ref</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">psi_interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Rinit</span><span class="p">,</span><span class="n">Zinit</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">psi_x</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_plane</span><span class="o">*</span><span class="n">Nrot</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Rinit</span><span class="p">,</span><span class="n">Zinit</span><span class="p">,</span><span class="s">&#39;rd&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;-x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R [m]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Z [m]&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">psi</span><span class="o">-</span><span class="n">psi_ref</span><span class="p">)</span><span class="o">/</span><span class="n">psi_ref</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Number of step&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Relative error in $\psi$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    </div>
<div class="viewcode-block" id="check_geometry"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.check_geometry">[docs]</a><span class="k">def</span> <span class="nf">check_geometry</span><span class="p">(</span><span class="n">minorR</span><span class="o">=</span><span class="mf">0.67</span><span class="p">,</span><span class="n">majorR</span><span class="o">=</span><span class="mf">1.67</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the geometry readed by the synthetic diagnostics</span>
<span class="sd">    The default Tokamak is the D3D (only a very simple model of the tokamak</span>
<span class="sd">    is considered)</span>

<span class="sd">    :param float minorR: Minor radius of the tokamak (distance between the center\</span>
<span class="sd">    of the plasma to the wall)</span>
<span class="sd">    :param float majorR: Major radius of the tokamak (distance between the symmetry axis\</span>
<span class="sd">    and the center of the plasma))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span> <span class="s">&#39;Default values assume D3D&#39;</span>

    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">foc</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">pos_foc</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">foc</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Top view&#39;</span><span class="p">)</span>
    <span class="n">perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">)</span>
    <span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">stdp</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">perp</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">stddev_h</span>
    <span class="n">stdm</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">perp</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">stddev_h</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;-x&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Beam&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stdp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">stdp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">stdm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">stdm</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Standard deviation&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">foc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">foc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Focus Points&#39;</span><span class="p">)</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">xmin_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">majorR</span><span class="o">-</span><span class="n">minorR</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">ymin_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">majorR</span><span class="o">-</span><span class="n">minorR</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>

    <span class="n">xmax_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">majorR</span><span class="o">+</span><span class="n">minorR</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">ymax_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">majorR</span><span class="o">+</span><span class="n">minorR</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xmin_tok</span><span class="p">,</span><span class="n">ymin_tok</span><span class="p">,</span><span class="n">xmax_tok</span><span class="p">,</span><span class="n">ymax_tok</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Tokamak&#39;</span><span class="p">)</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">limits</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_lens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_lens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;lens&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Limits&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Torroidal plane&#39;</span><span class="p">)</span>

    <span class="n">stdp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">stdm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">)</span>
    <span class="n">perp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">direc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">stdp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">perp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">stddev_v</span>
    <span class="n">stdm</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">perp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">stddev_v</span>
    <span class="n">stdp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">stdm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">mesh</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;-x&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Beam&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stdp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">stdp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">stdm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">stdm</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Standard deviation&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">foc</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">foc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Focus Points&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_lens</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">bes</span><span class="o">.</span><span class="n">pos_lens</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;lens&#39;</span><span class="p">)</span>

    <span class="n">rlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lim</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">rlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">rlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Limits&#39;</span><span class="p">)</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">x_tok</span> <span class="o">=</span> <span class="n">majorR</span><span class="o">+</span><span class="p">(</span><span class="n">majorR</span><span class="o">-</span><span class="n">minorR</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">y_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">majorR</span><span class="o">-</span><span class="n">minorR</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_tok</span><span class="p">,</span><span class="n">y_tok</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Tokamak&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    

</div>
<div class="viewcode-block" id="compute_beam_config"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.compute_beam_config">[docs]</a><span class="k">def</span> <span class="nf">compute_beam_config</span><span class="p">(</span><span class="n">Rsource</span><span class="p">,</span><span class="n">phisource</span><span class="p">,</span> <span class="n">Rtan</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])):</span>
    <span class="sd">&quot;&quot;&quot; Help to compute the value to put inside the config file</span>

<span class="sd">    :param float Rsource: R-coordinate of the beam source</span>
<span class="sd">    :param float phisource: :math:`\phi`-coordinate of the beam source</span>
<span class="sd">    :param float Rtan: Radius where the beam will be tangent</span>
<span class="sd">    :param np.array[N] R: R-coordinate of the fibers (if given, will print the\</span>
<span class="sd">    phi value for being in the beam)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">side</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Rsource</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">Rtan</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">Rsource</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Rtan</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">side</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Rsource</span><span class="o">*</span><span class="n">Rtan</span><span class="p">))</span>
    <span class="n">phitan</span> <span class="o">=</span> <span class="n">phisource</span> <span class="o">-</span> <span class="n">alpha</span>
    <span class="n">xtan</span> <span class="o">=</span> <span class="n">Rtan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">phitan</span><span class="p">)</span>
    <span class="n">ytan</span> <span class="o">=</span> <span class="n">Rtan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">phitan</span><span class="p">)</span>

    <span class="n">direc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xtan</span><span class="p">,</span><span class="n">ytan</span><span class="p">])</span>
    <span class="n">possource</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">phisource</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">phisource</span><span class="p">)])</span>
    <span class="n">possource</span> <span class="o">=</span> <span class="n">Rsource</span><span class="o">*</span><span class="n">possource</span>

    <span class="n">direc</span> <span class="o">=</span> <span class="n">direc</span> <span class="o">-</span> <span class="n">possource</span>
    <span class="n">direc</span> <span class="o">=</span> <span class="n">direc</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">direc</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;The position of the beam is :&#39;</span><span class="p">,</span> <span class="n">possource</span>
    <span class="k">print</span> <span class="s">&#39;The direction of the beam is :&#39;</span><span class="p">,</span> <span class="n">direc</span>
    <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">phifoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Rtan</span><span class="o">/</span><span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">phitan</span>
        <span class="k">print</span> <span class="s">&#39;If you want the fibers on the central line of the beam, Phi = &#39;</span><span class="p">,</span><span class="o">-</span><span class="n">phifoc</span>


</div>
<div class="viewcode-block" id="interpolation_toroidal_plane"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.interpolation_toroidal_plane">[docs]</a><span class="k">def</span> <span class="nf">interpolation_toroidal_plane</span><span class="p">(</span><span class="n">phi</span><span class="o">=-</span><span class="mf">2.58</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span><span class="n">Nr</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">Nz</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="p">[</span><span class="mf">1.82</span><span class="p">,</span><span class="mf">2.3</span><span class="p">],</span><span class="n">Z</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.25</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Create a R-Z mesh and interpolate the data on it.</span>
<span class="sd">    Is usefull for checking if the data are well interpolated</span>

<span class="sd">    :param float phi: Toroidal plane to compute</span>
<span class="sd">    :param int t: Time step</span>
<span class="sd">    :param int Nr: Number of radial points</span>
<span class="sd">    :param int Nz: Number of Z points</span>
<span class="sd">    :param list[] R: R min and max</span>
<span class="sd">    :param list[] Z: Z min and max</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="c"># will be increase in compute_beam_on_mesh</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">load_next_time_step</span><span class="p">(</span><span class="n">increase</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nr</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nz</span><span class="p">)</span>
    <span class="n">R</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    
    <span class="n">ne</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">interpolate_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">t</span><span class="p">,[</span><span class="s">&#39;ne&#39;</span><span class="p">],</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ne</span><span class="p">,(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Z</span><span class="p">,(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Electron Density&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">ne</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;R-coordinate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Z-coordinate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="solid_angle_evolution"><a class="viewcode-back" href="../../../../FPSDP.Diagnostics.BES.tools.html#FPSDP.Diagnostics.BES.tools.solid_angle_evolution">[docs]</a><span class="k">def</span> <span class="nf">solid_angle_evolution</span><span class="p">(</span><span class="n">Rmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">Zmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">Nr</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">Nz</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">fib</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the value of the solid angle as a function of R-Z (optical system)</span>
<span class="sd">    (Every parameter are in the unit of the focus point radius/distance to the lens)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bes</span> <span class="o">=</span> <span class="n">bes_</span><span class="o">.</span><span class="n">BES</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">Rmax</span><span class="p">,</span><span class="n">Rmax</span><span class="p">,</span><span class="n">Nr</span><span class="p">)</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">rad_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Zmax</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">Zmax</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">dist</span><span class="p">[</span><span class="n">fib</span><span class="p">]</span>

    <span class="n">Z</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s">&#39;ij&#39;</span><span class="p">)</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nz</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">bes</span><span class="o">.</span><span class="n">get_solid_angle</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">fib</span><span class="p">)</span>
        
    <span class="n">Z</span> <span class="o">-=</span> <span class="n">bes</span><span class="o">.</span><span class="n">dist</span><span class="p">[</span><span class="n">fib</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="c">#v = np.linspace(0,0.1,v)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">eps</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">bes</span><span class="o">.</span><span class="n">rad_foc</span><span class="p">[</span><span class="n">fib</span><span class="p">],</span><span class="s">&#39;-k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance from the central line&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Distance from the focus point along the central line&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Solid Angle&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="p">:</span><span class="mi">10</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="p">:</span><span class="mi">10</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Distance from the central line&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Solid Angle&#39;</span><span class="p">)</span>

    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../FPSDP.html">BES 1.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Loic Hausammann.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>